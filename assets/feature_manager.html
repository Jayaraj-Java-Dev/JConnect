<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JServ Manager</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
            margin: 0 auto;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .section {
            flex: 1;
            min-width: 300px;
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            text-align: left;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f1f1f1;
        }
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 8px 12px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        button.stop {
            background-color: #f44336;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-online {
            background-color: #4CAF50;
        }
        .status-offline {
            background-color: #f44336;
        }
        .refresh-bar {
            background-color: #eee;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .manager-section {
            margin-bottom: 20px;
        }
        .server-badge {
            display: inline-block;
            padding: 3px 8px;
            background-color: #e0e0e0;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 5px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        .toast.show {
            opacity: 1;
        }
        .info-bar {
            font-size: 12px;
            color: #666;
            text-align: right;
            margin-top: -10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>JServ Feature Manager</h1>
    <div class="info-bar">Last updated: 2025-08-02 06:19:00 by jayaraj-c-22540</div>
    
    <div class="refresh-bar">
        <span id="last-updated">Never updated</span>
        <div>
            <button onclick="refreshStatus()">Refresh</button>
        </div>
    </div>
    
    <div id="toast" class="toast"></div>
    
    <div class="container">
        <div class="section">
            <h2>SSH Servers</h2>
            <div class="manager-section">
                <h3>Start New SSH Session</h3>
                <div class="form-group">
                    <label for="ssh-session-id">Session ID:</label>
                    <input type="text" id="ssh-session-id" placeholder="Enter a unique session ID">
                </div>
                <div class="form-group">
                    <label for="ssh-server-select">Server:</label>
                    <select id="ssh-server-select">
                        <option value="">Loading servers...</option>
                    </select>
                </div>
                <button id="start-ssh-btn" onclick="startFeature('ssh')" disabled>Start SSH Session</button>
            </div>
            
            <h3>Active SSH Sessions</h3>
            <div id="ssh-sessions-loading" class="loading">Loading sessions...</div>
            <table id="ssh-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Session ID</th>
                        <th>Server</th>
                        <th>Started</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <div class="section">
            <h2>HTTP Servers</h2>
            <div class="manager-section">
                <h3>Start New HTTP Session</h3>
                <div class="form-group">
                    <label for="http-session-id">Session ID:</label>
                    <input type="text" id="http-session-id" placeholder="Enter a unique session ID">
                </div>
                <div class="form-group">
                    <label for="http-port">Port:</label>
                    <input type="number" id="http-port" placeholder="Enter port number (e.g., 8080)">
                </div>
                <div class="form-group">
                    <label for="http-server-select">Server:</label>
                    <select id="http-server-select">
                        <option value="">Loading servers...</option>
                    </select>
                </div>
                <button id="start-http-btn" onclick="startFeature('http')" disabled>Start HTTP Session</button>
            </div>
            
            <h3>Active HTTP Sessions</h3>
            <div id="http-sessions-loading" class="loading">Loading sessions...</div>
            <table id="http-table" style="display: none;">
                <thead>
                    <tr>
                        <th>Session ID</th>
                        <th>Port</th>
                        <th>Server</th>
                        <th>Started</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    
    <div class="section">
        <h2>Available Servers</h2>
        <div id="servers-loading" class="loading">Loading server registry...</div>
        <table id="servers-table" style="display: none;">
            <thead>
                <tr>
                    <th>Server ID</th>
                    <th>Type</th>
                    <th>Host</th>
                    <th>Started</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        // Server and session tracking
        let servers = {
            ssh: { servers: [] },
            http: { servers: [] },
            manage: { servers: [] }
        };
        let refreshInterval;
        
        // Initialize by refreshing the status
        document.addEventListener('DOMContentLoaded', function() {
            refreshStatus();
            
            // Set up auto-refresh every 10 seconds
            refreshInterval = setInterval(refreshStatus, 10000);
        });
        
        function refreshStatus() {
            fetch('/api/status')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    servers = data;
                    updateUI();
                    document.getElementById('last-updated').textContent = `Last updated: ${new Date().toLocaleString()}`;
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                    showToast('Failed to fetch server status', 'error');
                });
        }
        
        function updateUI() {
            // Update server selection dropdowns
            updateServerDropdowns();
            
            // Update the server list table
            updateServerList();
            
            // Update SSH sessions table
            updateSessionList('ssh');
            
            // Update HTTP sessions table
            updateSessionList('http');
        }
        
        // Replace the updateServerDropdowns function in the HTML file with this:

        function updateServerDropdowns() {
            const sshDropdown = document.getElementById('ssh-server-select');
            const httpDropdown = document.getElementById('http-server-select');
            
            // Clear existing options
            sshDropdown.innerHTML = '';
            httpDropdown.innerHTML = '';
            
            // Add default option            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select a server';

            httpDropdown.appendChild(defaultOption);
            sshDropdown.appendChild(defaultOption.cloneNode(true));
            
            // Only management servers can start new sessions
            const manageServers = servers.manage.servers.filter(server => 
                server.status === 'online');
            
            // Update both dropdowns with management servers
            if (manageServers.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No management servers available';
                option.disabled = true;
                httpDropdown.appendChild(option);
                sshDropdown.appendChild(option.cloneNode(true));
                document.getElementById('start-ssh-btn').disabled = true;
                document.getElementById('start-http-btn').disabled = true;
            } else {
                manageServers.forEach(server => {
                    const option = document.createElement('option');
                    option.value = server.serverId;
                    option.textContent = `${server.host} (${server.ip || 'unknown'})`;
                    httpDropdown.appendChild(option);
                    sshDropdown.appendChild(option.cloneNode(true));
                });
                document.getElementById('start-ssh-btn').disabled = false;
                document.getElementById('start-http-btn').disabled = false;
            }
        }
        
        function updateServerList() {
            const serversTable = document.getElementById('servers-table');
            const loadingElement = document.getElementById('servers-loading');
            const tbody = serversTable.querySelector('tbody');
            
            // Combine all servers
            const allServers = [
                // ...servers.ssh.servers,
                // ...servers.http.servers,
                ...servers.manage.servers
            ];
            
            if (allServers.length === 0) {
                loadingElement.textContent = 'No servers registered';
                serversTable.style.display = 'none';
                return;
            }
            
            loadingElement.style.display = 'none';
            serversTable.style.display = 'table';
            tbody.innerHTML = '';
            
            allServers.forEach(server => {
                const row = tbody.insertRow();
                
                // Server ID
                const idCell = row.insertCell();
                idCell.textContent = server.serverId;
                
                // Type
                const typeCell = row.insertCell();
                typeCell.textContent = getServerType(server);
                
                // Host
                const hostCell = row.insertCell();
                hostCell.textContent = `${server.host} (${server.ip || 'unknown IP'})`;
                
                // Started
                const startedCell = row.insertCell();
                startedCell.textContent = formatTime(server.startedAt);
                
                // Status
                const statusCell = row.insertCell();
                const statusIndicator = document.createElement('span');
                statusIndicator.className = `status-indicator status-${server.status === 'online' ? 'online' : 'offline'}`;
                statusCell.appendChild(statusIndicator);
                statusCell.appendChild(document.createTextNode(server.status || 'unknown'));
                
                // Actions
                const actionsCell = row.insertCell();
                const stopButton = document.createElement('button');
                stopButton.className = 'stop';
                stopButton.textContent = 'Stop';
                stopButton.onclick = () => stopServer(server.serverId);
                actionsCell.appendChild(stopButton);
            });
        }
        
        function updateSessionList(type) {
            const tableId = `${type}-table`;
            const loadingId = `${type}-sessions-loading`;
            const table = document.getElementById(tableId);
            const loadingElement = document.getElementById(loadingId);
            const tbody = table.querySelector('tbody');
            
            // Get sessions for this type (servers with sessionId)
            const sessionsServers = servers[type].servers.filter(server => server.sessionId);
            
            if (sessionsServers.length === 0) {
                loadingElement.textContent = `No active ${type.toUpperCase()} sessions`;
                table.style.display = 'none';
                return;
            }
            
            loadingElement.style.display = 'none';
            table.style.display = 'table';
            tbody.innerHTML = '';
            
            sessionsServers.forEach(server => {
                const row = tbody.insertRow();

                // Server ID
                const sidCell = row.insertCell();
                sidCell.textContent = server.serverId;
                
                // Session ID
                const idCell = row.insertCell();
                idCell.textContent = server.sessionId;
                
                // Port (HTTP only)
                if (type === 'http') {
                    const portCell = row.insertCell();
                    portCell.textContent = server.port || 'Default';
                }
                
                // Server
                const serverCell = row.insertCell();
                serverCell.textContent = `${server.host} (${server.ip || 'unknown'})`;
                
                // Started
                const startedCell = row.insertCell();
                startedCell.textContent = formatTime(server.startedAt);
                
                // Status
                const statusCell = row.insertCell();
                const statusIndicator = document.createElement('span');
                statusIndicator.className = `status-indicator status-${server.status === 'online' ? 'online' : 'offline'}`;
                statusCell.appendChild(statusIndicator);
                statusCell.appendChild(document.createTextNode(server.status || 'unknown'));
                
                // Actions
                const actionsCell = row.insertCell();
                const stopButton = document.createElement('button');
                stopButton.className = 'stop';
                stopButton.textContent = 'Stop';
                stopButton.onclick = () => stopServer(server.serverId);
                actionsCell.appendChild(stopButton);
            });
        }
        
        function getServerType(server) {
            if (server.type === 'ssh') return 'SSH Server';
            if (server.type === 'http') return 'HTTP Server';
            if (server.type === 'manage') return 'Management Server';
            return 'Unknown';
        }
        
        function startFeature(featureType) {
            const sessionId = document.getElementById(`${featureType}-session-id`).value.trim();
            if (!sessionId) {
                showToast('Please enter a session ID', 'error');
                return;
            }
            
            const serverId = document.getElementById(`${featureType}-server-select`).value;
            if (!serverId) {
                showToast('Please select a server', 'error');
                return;
            }
            
            let port = null;
            if (featureType === 'http') {
                port = document.getElementById('http-port').value.trim();
                if (port) port = parseInt(port, 10);
            }
            
            // Send request to start feature on the selected server
            fetch(`/api/feature/${featureType}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'start',
                    sessionId,
                    serverId,
                    port
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Failed to start session');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showToast(`Started ${featureType} session with ID ${sessionId}`, 'success');
                    
                    // Clear the input fields
                    document.getElementById(`${featureType}-session-id`).value = '';
                    if (featureType === 'http') {
                        document.getElementById('http-port').value = '';
                    }
                    
                    // Refresh the status after a short delay to see the new session
                    setTimeout(refreshStatus, 1000);
                } else {
                    showToast(data.error || 'Unknown error', 'error');
                }
            })
            .catch(error => {
                showToast(error.message, 'error');
            });
        }
        
        function stopServer(serverId) {
            if (!confirm('Are you sure you want to stop this server?')) {
                return;
            }
            
            fetch('/api/feature/server', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'stop',
                    serverId
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Failed to stop server');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showToast('Server stopping command sent', 'success');
                    
                    // Refresh the status after a short delay
                    setTimeout(refreshStatus, 1000);
                } else {
                    showToast(data.error || 'Unknown error', 'error');
                }
            })
            .catch(error => {
                showToast(error.message, 'error');
            });
        }
        
        function formatTime(timestamp) {
            if (!timestamp) return 'Unknown';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            
            // Just show time if today, otherwise show date too
            const options = { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            };
            
            if (diffMs > 24 * 60 * 60 * 1000) {
                options.year = 'numeric';
                options.month = 'short';
                options.day = 'numeric';
            }
            
            return date.toLocaleString(undefined, options);
        }
        
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }
        
        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            clearInterval(refreshInterval);
        });
    </script>
</body>
</html>